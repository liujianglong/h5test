<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <title>表情总动员</title>
    <style>
        body {
            background-color: #FDEA3F;
            text-align: center;
            margin: 0;
        }

        /*emoji图片的div容器*/
        #emoji {
            text-align: center;
            position: absolute;
            bottom: 2%;
            width: 80%;
            height: 75%;
            background-color: #87fffc;
            border-radius: 12px;
            border: solid 1px #87fffc;
        }

        #emoji_text {
            text-align: center;
            position: absolute;
            width: 100%;
            bottom: 3%;
        }

        /*测试用的页面顶部title*/
        #title1, #title2 {
            text-align: center;
        }

        /*emoji图片*/
        .emojiImg {
            border: solid 1px #ffffff;
        }

        /*打开相册按钮（隐藏）*/
        #uploadImg {
            display: none;
            position: absolute;
            left: 10px;
            top: 10px;
            width: 278px;
            height: 78px
        }
    </style>
</head>
<body>
<script src="../asset/transform.js"></script>
<script src="../alloy_finger.js"></script>
<script src="../EmojiH5/js/wechat_share.js"></script>

<div id="first_page" style="text-align: center">
    <br>
    <br>
    <span id="title1" style="font-size: 16px">表情总动员</span><br>
    <span id="title2" style="font-size: 32px">春季运动会</span>
    <input type="file" id="uploadImg">

    <div id="outter_div" style="text-align: center; margin: 0 auto; width: 80%;">
        <div id="emoji">
            <div id="emoji_text">
                <span style="font-size: 14px;">点击表情，上传自拍</span><br>
                <span style="font-size: 14px;">生成专属表情包</span>
            </div>
        </div>
    </div>
</div>

<div id="second_page" style="text-align: center;">
    <br>
    <br>
    <img id="selected_emoji" width="80%" style="top: 10%;" src="" alt=""/>
    <p>长按图片<strong>转发</strong>或<strong>保存</strong></p>

    <div style="position: absolute; width: 100%; bottom: 10%;">
        <span style="color: #226dff; padding: 17px;" id="change_sport" onclick="changeSport()">换个运动</span>
        <span style="color: firebrick; padding: 17px;" id="call_friend">召唤朋友</span>
    </div>

</div>


<script>

    //    添加测试图片列表，并添加交互动作监听
    function addEmojiImg(index, srcString) {
        var img = document.createElement("img");
        img.setAttribute("class", "emojiImg");
        img.setAttribute("id", "emojiImg" + index);
        img.setAttribute("src", srcString);
        var outter = document.getElementById("outter_div");
        var w = (outter.clientWidth - 5) * 10 / 23 + "px";
        img.setAttribute("width", w);
        if (index <= 1) {
            img.style.marginTop = (outter.clientWidth - 5) / 23 + "px";
        } else {
            img.style.marginTop = (outter.clientWidth - 5) / 46 + "px";
        }
        if (index % 2 == 0) {
            img.style.marginLeft = (outter.clientWidth - 5) / 23 + "px";
            img.style.marginRight = (outter.clientWidth - 5) / 46 + "px";
        } else {
            img.style.marginLeft = (outter.clientWidth - 5) / 46 + "px";
            img.style.marginRight = (outter.clientWidth - 5) / 23 + "px";
        }
        img.style.marginBottom = (outter.clientWidth - 5) / 46 + "px";

        var title = document.getElementById("title1");
        var uploadImg = document.getElementById("uploadImg");
        Transform(img);
        var initScale = 1;
        var gesture = new AlloyFinger(img, {
            tap: function (evt) {
                title.innerHTML = "emojiImg" + index;
//                restoreBackgroundColor(4);
//                img.style.borderColor = "#B02B0A"
//                uploadImg.click();

                var secondPage = document.getElementById("second_page");
                var firstPage = document.getElementById("first_page");

                var src = img.getAttribute("src");
                var selectedEmoji = document.getElementById("selected_emoji");
                selectedEmoji.setAttribute("src", src);
                firstPage.style.display = "none";
                secondPage.style.display = "block";
            }
//            ,
//            rotate: function (evt) {
//                img.rotateZ += evt.angle;
//            },
//            pinchStart: function () {
//                initScale = img.scaleX;
//            },
//            multipointStart: function () {
//                initScale = img.scaleX;
//            },
//            pinch: function (evt) {
//                img.scaleX = img.scaleY = initScale * evt.scale;
//            },
//            pressMove: function (evt) {
//                img.translateX += evt.deltaX;
//                img.translateY += evt.deltaY;
//            }
        });

        var emojiDiv = document.getElementById("emoji");
        emojiDiv.insertBefore(img, document.getElementById("emoji_text"));
    }

    //    选择图片完成回调函数
    function onUploadImageDone() {
        var title = document.getElementById("title1");

        var file = this.files[0];
        if (!/image\/\w+/.test(file.type)) {
            alert("请确保文件为图像类型");
            return false;
        }
        var reader = new FileReader();
        reader.readAsDataURL(file);
        console.log();
        reader.onload = function (e) {
            var emoji = document.getElementById(title.innerHTML);
            emoji.setAttribute("src", this.result);
        }
    }

    //    更换选中图片后，重置图片背景色
    function restoreBackgroundColor(count) {
        for (var i = 0; i < count; i++) {
            var img = document.getElementById("emojiImg" + i);
            img.style.borderColor = "#87fffc"
        }
    }

    function changeSport() {
        var firstPage = document.getElementById("first_page");
        var secondPage = document.getElementById("second_page");

        firstPage.style.display = "block";
        secondPage.style.display = "none";
    }

    window.onload = function () {
        var uploadImage = document.getElementById("uploadImg");
        uploadImage.addEventListener('change', onUploadImageDone, false);
        var count = 4;
        for (var i = 0; i < count; i++) {
            addEmojiImg(i, "../asset/emoji.gif");
        }
        var secondPage = document.getElementById("second_page");
        secondPage.style.display = "none";
    }

</script>
</body>
</html>